

# 照片墙上传方案优化

## 当前问题

现有实现采用**逐张串行上传**，36 张照片（每张最大 5MB）在网络较慢时体验很差，且没有总传输量限制和上传进度反馈。

## 优化方案

### 文件：`src/components/PhotoWall.tsx`

#### 1. 新增总传输量限制 (52MB)

在 `handleUpload` 中先计算所有选中文件的总大小，超过 52MB 时直接拒绝并提示用户。

```text
const MAX_TOTAL_SIZE = 52 * 1024 * 1024; // 52MB
const totalSize = Array.from(files).reduce((sum, f) => sum + f.size, 0);
if (totalSize > MAX_TOTAL_SIZE) {
  toast.error("本次上传总大小超过 52MB 限制");
  return;
}
```

#### 2. 并发上传（最多 6 路并行）

将串行 `for` 循环改为并发批处理模式，每批最多 6 张同时上传，大幅提升速度。

```text
流程：
文件列表 → 验证+压缩 → 分批(每批6张) → 并发上传 → 汇总结果
```

#### 3. 实时上传进度

新增 `uploadProgress` 状态，上传按钮文案从 "Uploading..." 改为 "正在上传 3/12..."，让用户清楚知道进度。

#### 4. 失败重试机制

单张上传失败时自动重试 1 次，降低因网络波动导致的失败率。

### 技术细节

| 项目 | 当前值 | 修改后 |
|------|--------|--------|
| 上传模式 | 串行逐张 | 并发 6 路 |
| 总大小限制 | 无 | 52MB |
| 单张大小限制 | 5MB | 5MB（不变） |
| 最大照片数 | 36 | 36（不变） |
| 进度显示 | "Uploading..." | "正在上传 3/12..." |
| 失败重试 | 无 | 自动重试 1 次 |

### 具体修改点

1. **常量定义区**：新增 `MAX_TOTAL_SIZE = 52 * 1024 * 1024` 和 `CONCURRENT_LIMIT = 6`
2. **状态区**：新增 `uploadProgress` state（格式 `{current: number, total: number}`）
3. **handleUpload 函数**：重写上传逻辑
   - 前置校验：文件数量 + 总大小
   - 验证阶段：逐文件校验格式和单文件大小
   - 压缩阶段：并发压缩所有有效文件
   - 上传阶段：分批并发上传，每完成一张更新进度
   - 重试逻辑：失败后等待 1 秒重试 1 次
4. **上传按钮文案**：根据 `uploadProgress` 显示实时进度

